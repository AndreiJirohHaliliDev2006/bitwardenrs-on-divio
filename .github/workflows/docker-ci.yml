name: Docker CI

on:
  # Disabled cronjobs first until we configured the change detection logic.
  #schedule:
  #  - cron: '30 3 * * *'
  push:
    branches: [ main, 'ajhalili2006/**' ]
    # Publish semver tags as releases.
    tags: [ 'v*.*.*' ]
    # TODO: use paths-filter action later
    paths:
      - "Dockerfile"
      - "vaultwarden-startup"
      - ".github/workflows/docker-ci.yml"
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  RHQCR_NAMESPACE: recaptime-dev/vaultwarden
  GITLAB_MAUDEV_NAMESPACE: recaptime/infra/docker/vaultwarden
  GHCR_NAMESPACE: recaptime/vaultwarden-docker
  DOCKERHUB_NAMESPACE: ajhalili2006 # TODO: Update this before I add Docker Hub login stuff.

jobs:
  docker-build:
    name: Build and push
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # use GITHUB_TOKEN instead of my PAT for security reasons

    steps:
      - name: Checkout repository
        uses: actions/checkout@8f4b7f84864484a7bf31766abe9204da3cbe65b3

      - name: Install CLI
        uses: dopplerhq/cli-action@41106dbef2e821dcf2250b0c936a616a438a278a
      - uses: dopplerhq/secrets-fetch-action@41d4e028164b97f7ae21b1893107b59a81264fdc
        id: doppler
        if: github.event_name != 'pull_request'
        with:
          doppler-token: ${{ secrets.OCI_REGISTRY_DOPPLER_TOKEN }}

      # Login against a Docker registry except on PR
      # https://github.com/docker/login-action
      - name: Authenicate to GHCR
        if: github.event_name != 'pull_request'
        uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20av2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Authenticate to RHQCR
        if: github.event_name != 'pull_request'
        uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a
        with:
          registry: quay.io
          username: ${{ steps.doppler.outputs.RHQCR_SERVICE_ACCOUNT_USERNAME }}
          password: ${{ steps.doppler.outputs.RHQCR_SERVICE_ACCOUNT_PASSWORD }}
      - name: Authenticate with dock.mau.dev
        if: github.event_name != 'pull_request'
        uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a
        with:
          registry: dock.mau.dev
          username: ${{ steps.doppler.outputs.GITLAB_MAUDEV_SERVICE_ACCOUNT_USERNAME }}
          password: ${{ steps.doppler.outputs.GITLAB_MAUDEV_SERVICE_ACCOUNT_PASSWORD }}

      # Extract metadata (tags, labels) for Docker
      # https://github.com/docker/metadata-action
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@507c2f2dc502c992ad446e3d7a5dfbe311567a96
        with:
          images: |
            ghcr.io/${{ env.GHCR_NAMESPACE }}
            dock.mau.dev/${{ env.GITLAB_MAUDEV_NAMESPACE }}
            quay.io/${{ env.RHQCR_NAMESPACE }}
          labels: |
            org.opencontainers.image.vendor=Andrei Jiroh Halili
          tags: |
            type=ref,prefix=branch-,event=branch
            type=sha,format=long,prefix=commit-
            type=raw,value=latest,enable={{is_default_branch}}

      # Then set up QEMU and Buildx so the Build and push action below will not trigger errors
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2e81a89b1732b9c48d79cd809d8d81d79c4647a18
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@4b4e9c3e2d4531116a6f8ba8e71fc6e2cb6e6c8c
        
      # Build and push Docker image with Buildx (don't push on PR)
      # https://github.com/docker/build-push-action
      - name: Build and push Docker image
        uses: docker/build-push-action@3b5e8027fcad23fda98b2e3ac259d8d67585f671
        with:
          context: .
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          provenance: false
